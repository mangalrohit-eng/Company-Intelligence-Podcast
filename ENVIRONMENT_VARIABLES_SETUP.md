# Environment Variables Setup Guide

## Where to Set the 3 Environment Variables

### 1. For Local Development

**You DON'T need CloudFront for local development!** 

In local development:
- Audio files are served from your local file system (`output/episodes/` folder)
- The serve-file API checks local files first, and only falls back to S3 if not found
- CloudFront is only needed in production

**Optional `.env` file** (only if you want to test S3/CloudFront locally):

```bash
# Location: .env (in project root, same level as package.json)
# NOTE: These are OPTIONAL for local dev - files work from local disk

# AWS Configuration (only needed if testing S3 access)
AWS_REGION=us-east-1

# S3 Bucket (only needed if testing S3 fallback)
# Format: podcast-platform-media-{YOUR_AWS_ACCOUNT_ID}
# Example: podcast-platform-media-098478926952
S3_BUCKET_NAME=podcast-platform-media-098478926952

# CloudFront (NOT needed for local - files come from local disk)
# Only set this if you want to test CloudFront redirects locally
# CLOUDFRONT_DOMAIN=dhycfwg0k4xij.cloudfront.net
```

**For normal local development, you can skip the `.env` file entirely!** Files will be served from your local `output/` directory.

---

### 2. For Production (ECS/Load Balancer)

You need to add these to the CDK stack configuration.

**File:** `infra/cdk/lib/podcast-platform-stack.ts`

**Location:** Around line 481, in the `environment` section of the ECS container:

```typescript
appTaskDef.addContainer('app', {
  // ... existing config ...
  environment: {
    AWS_REGION: this.region,  // ✅ Already set
    // ... other existing vars ...
    MEDIA_BUCKET: mediaBucket.bucketName,  // ✅ Already set
    
    // ADD THESE THREE LINES:
    S3_BUCKET_NAME: mediaBucket.bucketName,  // ← Add this
    S3_BUCKET_MEDIA: mediaBucket.bucketName,  // ← Add this (for compatibility)
    CLOUDFRONT_DOMAIN: 'dhycfwg0k4xij.cloudfront.net',  // ← Add this (or make dynamic)
    
    // ... rest of existing vars ...
  },
});
```

**Or better yet, make CloudFront dynamic:**

If you have a CloudFront distribution created in CDK, reference it:

```typescript
// First, find or create your CloudFront distribution in the CDK stack
// Then reference it:
CLOUDFRONT_DOMAIN: cloudFrontDistribution.distributionDomainName,
```

---

## Quick Fix: Update CDK Stack

Here's exactly what to add to `infra/cdk/lib/podcast-platform-stack.ts`:

### Step 1: Find the ECS container environment section (around line 481)

### Step 2: Add these 3 lines to the environment object:

```typescript
environment: {
  AWS_REGION: this.region,  // ✅ Already there
  // ... existing vars ...
  MEDIA_BUCKET: mediaBucket.bucketName,  // ✅ Already there
  
  // ADD THESE:
  S3_BUCKET_NAME: mediaBucket.bucketName,
  S3_BUCKET_MEDIA: mediaBucket.bucketName,
  CLOUDFRONT_DOMAIN: 'dhycfwg0k4xij.cloudfront.net',  // Use your actual domain
  
  // ... rest of existing vars ...
},
```

### Step 3: Redeploy

After updating the CDK stack:

```bash
cd infra/cdk
npm run deploy
# or
cdk deploy
```

---

## Variable Name Mapping

The code looks for these variable names (in order of priority):

| Code Expects | CDK Sets | Solution |
|-------------|----------|----------|
| `S3_BUCKET_NAME` | `MEDIA_BUCKET` | Add `S3_BUCKET_NAME: mediaBucket.bucketName` |
| `S3_BUCKET_MEDIA` | `MEDIA_BUCKET` | Add `S3_BUCKET_MEDIA: mediaBucket.bucketName` |
| `CLOUDFRONT_DOMAIN` | (not set for ECS) | Add `CLOUDFRONT_DOMAIN: 'your-domain.cloudfront.net'` |
| `NEXT_PUBLIC_CLOUDFRONT_DOMAIN` | (not set) | Add if needed for client-side |

---

## Finding Your Actual Values

### S3 Media Bucket Name

The bucket name is automatically generated by CDK:
- **Format:** `podcast-platform-media-{AWS_ACCOUNT_ID}`
- **Example:** `podcast-platform-media-098478926952`

To find your exact bucket name:

**Option 1: Check AWS Console**
1. Go to AWS Console → S3
2. Look for a bucket starting with `podcast-platform-media-`
3. The full name will be `podcast-platform-media-{your-account-id}`

**Option 2: Check CDK Stack**
- The bucket is defined in `infra/cdk/lib/podcast-platform-stack.ts` line 34:
  ```typescript
  bucketName: `podcast-platform-media-${this.account}`
  ```
- `this.account` is your AWS account ID (12 digits)

**Option 3: Check CDK Outputs**
```bash
cd infra/cdk
cdk deploy --outputs-file outputs.json
# Look for MediaBucketName in the outputs
```

### CloudFront Domain
1. Go to AWS Console → CloudFront
2. Find your distribution (should be created by CDK)
3. Copy the domain name (e.g., `d1234567890abc.cloudfront.net`)
4. Use it **without** `https://` prefix

**Note:** CloudFront is only needed in production. Local development serves files from disk.

### AWS Region
Already set in CDK as `this.region` (usually `us-east-1`)

---

## Summary

### Local Development
- **File:** `.env` in project root (OPTIONAL - not required!)
- **Why optional:** Files are served from local `output/` directory
- **Only set if:** You want to test S3/CloudFront fallback locally
- **Variables (if needed):**
  ```bash
  AWS_REGION=us-east-1
  S3_BUCKET_NAME=podcast-platform-media-098478926952  # Replace with your account ID
  # CLOUDFRONT_DOMAIN not needed for local dev
  ```

### Production (ECS)
- **File:** `infra/cdk/lib/podcast-platform-stack.ts`
- **Location:** ECS container `environment` section (line ~481)
- **Add:**
  ```typescript
  S3_BUCKET_NAME: mediaBucket.bucketName,
  S3_BUCKET_MEDIA: mediaBucket.bucketName,
  CLOUDFRONT_DOMAIN: 'your-domain.cloudfront.net',
  ```
- **Then:** Redeploy with `cdk deploy`

---

## Verification

After setting the variables, verify they're working:

1. **Local:** Check console logs when starting dev server
2. **Production:** Check ECS task definition in AWS Console
   - Go to ECS → Task Definitions → Your task → Container definitions
   - Verify environment variables are listed

