version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        # Create .env.production file from Amplify environment variables
        # This ensures variables are available at runtime for Next.js API routes
        - |
          echo "Creating .env.production file for runtime access..."
          # Remove existing file if any
          rm -f .env.production
          # Create new file with all required variables
          {
            [ -n "$AMPLIFY_ACCESS_KEY_ID" ] && echo "AMPLIFY_ACCESS_KEY_ID=$AMPLIFY_ACCESS_KEY_ID" || echo "# AMPLIFY_ACCESS_KEY_ID not set"
            [ -n "$AMPLIFY_SECRET_ACCESS_KEY" ] && echo "AMPLIFY_SECRET_ACCESS_KEY=$AMPLIFY_SECRET_ACCESS_KEY" || echo "# AMPLIFY_SECRET_ACCESS_KEY not set"
            [ -n "$S3_BUCKET_MEDIA" ] && echo "S3_BUCKET_MEDIA=$S3_BUCKET_MEDIA" || echo "# S3_BUCKET_MEDIA not set"
            [ -n "$REGION" ] && echo "REGION=$REGION" || echo "# REGION not set"
            [ -n "$ACCOUNT_ID" ] && echo "ACCOUNT_ID=$ACCOUNT_ID" || echo "# ACCOUNT_ID not set"
          } > .env.production
          echo ".env.production created:"
          cat .env.production | sed 's/\(SECRET\|KEY\)=.*/\1=***HIDDEN***/' || true
          echo "File has $(wc -l < .env.production) lines"
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
    # Include .env.production in build artifacts so it's available at runtime
    name: amplify-build
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
