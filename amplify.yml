version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        # Create .env.production file from Amplify environment variables
        # This ensures variables are available at runtime for Next.js API routes
        - |
          echo "Creating .env.production file for runtime access..."
          echo "=== Debug: Checking environment variables ==="
          echo "AMPLIFY_ACCESS_KEY_ID length: ${#AMPLIFY_ACCESS_KEY_ID}"
          echo "AMPLIFY_SECRET_ACCESS_KEY length: ${#AMPLIFY_SECRET_ACCESS_KEY}"
          echo "All env vars containing 'AMPLIFY':"
          env | grep -i amplify || echo "No AMPLIFY variables found in environment"
          echo "All env vars containing 'ACCESS':"
          env | grep -i access || echo "No ACCESS variables found"
          echo "=============================================="
          # Remove existing file if any
          rm -f .env.production
          # Create new file with all required variables
          # Try to get the value, even if it seems empty
          {
            if [ -n "${AMPLIFY_ACCESS_KEY_ID}" ]; then
              echo "AMPLIFY_ACCESS_KEY_ID=${AMPLIFY_ACCESS_KEY_ID}"
            else
              echo "# AMPLIFY_ACCESS_KEY_ID not set or empty"
            fi
            if [ -n "${AMPLIFY_SECRET_ACCESS_KEY}" ]; then
              echo "AMPLIFY_SECRET_ACCESS_KEY=${AMPLIFY_SECRET_ACCESS_KEY}"
            else
              echo "# AMPLIFY_SECRET_ACCESS_KEY not set or empty"
            fi
            [ -n "$S3_BUCKET_MEDIA" ] && echo "S3_BUCKET_MEDIA=$S3_BUCKET_MEDIA" || echo "# S3_BUCKET_MEDIA not set"
            [ -n "$REGION" ] && echo "REGION=$REGION" || echo "# REGION not set"
            [ -n "$ACCOUNT_ID" ] && echo "ACCOUNT_ID=$ACCOUNT_ID" || echo "# ACCOUNT_ID not set"
          } > .env.production
          echo ".env.production created:"
          cat .env.production | sed 's/\(SECRET\|KEY\)=.*/\1=***HIDDEN***/' || true
          echo "File has $(wc -l < .env.production) lines"
          # Copy .env.production to .next directory so it's available at runtime
          # Next.js API routes need access to this file
          echo "Copying .env.production to .next directory for runtime access..."
          mkdir -p .next
          cp .env.production .next/.env.production || true
          echo "Verifying .env.production in .next:"
          [ -f .next/.env.production ] && echo "✅ .env.production copied to .next" || echo "❌ Failed to copy .env.production"
    build:
      commands:
        - npm run build
        # Ensure .env.production is still available after build
        - |
          if [ -f .env.production ]; then
            echo "✅ .env.production exists in root after build"
            cp .env.production .next/.env.production 2>/dev/null || true
          else
            echo "⚠️ .env.production not found in root after build"
          fi
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
    # Include .env.production in build artifacts so it's available at runtime
    name: amplify-build
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
